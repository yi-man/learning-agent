---
description: 依赖管理和测试验证规则 - 确保依赖一致性和代码质量
alwaysApply: true
---

# 依赖管理和测试验证规则

## 规则 1: 依赖安装必须通过 requirements.txt

**严格要求：** 所有 Python 依赖包的安装必须通过 `requirements.txt` 文件管理，禁止直接使用 `pip install package` 命令。

### 正确流程

1. **更新 requirements.txt**
   - 添加新依赖时，先更新 `requirements.txt` 文件
   - 指定版本号（如 `pytest>=7.0.0`）
   - 添加注释说明依赖用途（如 `# 测试依赖`）

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

### 禁止的操作

- ❌ 直接运行 `pip install pytest`
- ❌ 跳过更新 `requirements.txt` 直接安装包
- ❌ 在代码中假设依赖已安装而不更新 requirements.txt

### 原因

- **一致性**：确保所有环境（开发、测试、生产）使用相同的依赖版本
- **可追溯性**：requirements.txt 是依赖的单一真实来源
- **可重现性**：其他人可以通过 requirements.txt 重建相同的环境

## 规则 2: 代码完成后必须进行自测

**严格要求：** 完成代码编写后，必须安装依赖并运行测试进行验证，确保代码能够正常工作。

### 正确流程

1. **更新依赖文件**
   - 如果添加了新依赖，先更新 `requirements.txt`

2. **安装依赖**

   ```bash
   pip install -r requirements.txt
   ```

3. **运行测试验证**

   ```bash
   # 运行所有测试
   pytest -v

   # 或运行特定测试文件
   pytest tests/test_new_feature.py -v
   ```

4. **验证通过后再提交**
   - 确保所有测试通过
   - 确保没有语法错误
   - 确保没有导入错误

### 禁止的操作

- ❌ 编写代码后不运行测试就声称完成
- ❌ 假设依赖已安装而不验证
- ❌ 跳过测试验证步骤

### 原因

- **质量保证**：及早发现问题和错误
- **避免返工**：在提交前发现问题比提交后修复更高效
- **可靠性**：确保代码在真实环境中能够运行

## 规则 3: 修复用户报错后必须立即验证

**严格要求：** 当用户报错某个命令失败时，修复后必须立即运行用户报错的**完全相同**的命令来验证修复是否有效。

**⚠️ 核心原则：**

- ✅ 识别用户报错的具体命令（从终端输出、错误信息、用户描述中提取）
- ✅ 修复后：必须立即运行**用户报错的完全相同命令**（包括所有参数、选项、路径等）
- ❌ **不能**运行其他命令来验证（即使看起来"等价"）
- ❌ **不能**等用户提醒才验证
- ❌ **不能**声称"应该可以工作"而不实际运行

**⚠️ 验证命令必须：**

1. **从用户报错中识别**：仔细阅读用户提供的错误信息、终端输出，提取失败的具体命令
2. 与用户报错的命令**完全相同**（包括所有参数、选项、路径、环境变量等）
3. 在修复后的**同一个工具调用批次中**立即执行
4. 展示完整的输出结果和退出码
5. 确认修复有效后才能声称完成

### 正确流程

1. **识别用户报错的具体命令**
   - 从用户提供的终端输出、错误信息、附件中提取失败的命令
   - 注意命令的所有参数、选项、路径等细节
   - 例如：用户报错 `pytest --cov=app --cov-report=html`，就运行这个完全相同的命令

2. **诊断并修复问题**
   - 分析错误信息，找出根本原因
   - 实施修复（如添加缺失的依赖、修复配置、修正代码等）

3. **立即运行用户报错的命令验证**（**必须立即执行**）

   ```bash
   # 运行用户报错的完全相同命令（根据实际情况替换）
   # 例如：如果用户报错的是 pytest --cov=app --cov-report=html
   # 就运行：pytest --cov=app --cov-report=html
   # 如果用户报错的是 npm run build
   # 就运行：npm run build
   ```

4. **确认修复有效**
   - 看到命令成功执行（exit code 0）
   - 看到预期的输出结果
   - **然后才能声称问题已解决**

### 禁止的操作

- ❌ 修复后不运行用户报错的命令就声称完成
- ❌ 运行不同的命令来验证（如用户报错 `pytest --cov=app --cov-report=html`，你却只运行 `pytest -v`）
- ❌ 等待用户提醒才运行验证命令
- ❌ 声称"应该可以工作"而不实际运行
- ❌ 假设修复有效而不验证
- ❌ **忽略命令的某些参数或选项**（如用户报错包含 `--cov-report=html`，你却只运行 `--cov`）

### 原因

- **验证修复有效性**：只有运行原始命令才能确认修复真正有效
- **避免误判**：修复可能不完整，运行原始命令能发现遗漏
- **建立信任**：实际验证结果比假设更可靠
- **符合 verification-before-completion 原则**：证据优先于断言

## 完整工作流程示例

当添加新功能或修改代码时：

```bash
# 1. 更新 requirements.txt（如果需要新依赖）
# 编辑 requirements.txt，添加新依赖

# 2. 安装依赖
pip install -r requirements.txt

# 3. 编写代码
# ... 编写代码 ...

# 4. 运行测试验证
pytest -v

# 5. 确认测试通过后，再进行后续操作（提交、部署等）
```

## 特殊情况

- **开发环境设置**：首次设置项目时，运行 `pip install -r requirements.txt` 安装所有依赖
- **CI/CD**：持续集成环境也应使用 `pip install -r requirements.txt` 安装依赖
- **文档更新**：如果添加了新的依赖，记得更新 README.md 中的安装说明

## 检查清单

在完成任何代码修改后，确认：

- [ ] 所有新依赖已添加到 `requirements.txt`
- [ ] 已运行 `pip install -r requirements.txt` 安装依赖
- [ ] 已运行 `pytest -v` 验证测试通过
- [ ] 没有语法错误或导入错误
- [ ] 代码能够正常运行
