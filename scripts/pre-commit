#!/bin/bash
#
# Git pre-commit hook
# 在提交前自动运行代码质量检查：format、lint、type-check
#

# 获取项目根目录
PROJECT_ROOT=$(git rev-parse --show-toplevel)
cd "$PROJECT_ROOT" || exit 1

# 检查虚拟环境是否存在
VENV="$PROJECT_ROOT/venv"
if [ ! -d "$VENV" ]; then
    echo "⚠️  警告: 虚拟环境不存在，跳过 pre-commit 检查"
    echo "提示: 运行 'make setup' 初始化项目"
    exit 0  # 允许提交，避免阻塞首次设置
fi

VENV_BIN="$VENV/bin"
MAKE="make"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 辅助函数：添加被修改的 Python 文件到暂存区
add_modified_python_files() {
    # 获取所有被修改的 Python 文件（包括已暂存和未暂存的）
    MODIFIED_FILES=$(git diff --name-only --diff-filter=ACM | grep '\.py$' || true)
    if [ -n "$MODIFIED_FILES" ]; then
        echo "$MODIFIED_FILES" | while read -r file; do
            if [ -f "$file" ]; then
                git add "$file" 2>/dev/null || true
            fi
        done
        return 0
    fi
    return 1
}

echo ""
echo "🔍 运行 pre-commit 检查..."
echo ""

# 1. 格式化代码
echo "📝 步骤 1/3: 格式化代码..."
if ! $MAKE format > /dev/null 2>&1; then
    echo -e "${RED}❌ 格式化失败${NC}"
    exit 1
fi

# 检查是否有文件被格式化修改并添加到暂存区
if add_modified_python_files; then
    echo "📦 检测到格式化修改，已添加到暂存区"
fi

# 2. 代码检查并自动修复
echo "🔍 步骤 2/3: 代码检查并自动修复..."
if ! $MAKE lint-fix > /dev/null 2>&1; then
    echo -e "${RED}❌ 代码检查失败（有无法自动修复的问题）${NC}"
    echo ""
    echo "请运行以下命令查看详细错误："
    echo "  make lint"
    exit 1
fi

# 检查是否有文件被 lint-fix 修改并添加到暂存区
if add_modified_python_files; then
    echo "📦 检测到 lint 修复，已添加到暂存区"
fi

# 再次运行 lint 检查，确保没有剩余问题
echo "🔍 验证代码检查..."
if ! $MAKE lint > /dev/null 2>&1; then
    echo -e "${RED}❌ 代码检查失败（仍有未修复的问题）${NC}"
    echo ""
    echo "请运行以下命令查看详细错误："
    echo "  make lint"
    exit 1
fi

# 3. 类型检查
echo "🔎 步骤 3/3: 类型检查..."
if ! $MAKE type-check > /dev/null 2>&1; then
    echo -e "${RED}❌ 类型检查失败${NC}"
    echo ""
    echo "请运行以下命令查看详细错误："
    echo "  make type-check"
    exit 1
fi

echo ""
echo -e "${GREEN}✅ 所有检查通过，允许提交${NC}"
echo ""
exit 0
